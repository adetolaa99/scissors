<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shorten URL</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <body>
    <%- include('partials/navbar') %>
    <div id="loading">Loading...</div>
    <div id="content" style="display: none">
      <h1>Shorten URL</h1>
      <form id="shortenForm" action="/api/shorten" method="POST">
        <label for="longURL">Long URL:</label>
        <input type="text" id="longURL" name="longURL" required />

        <label for="customDomain">Custom Domain (optional):</label>
        <input type="text" id="customDomain" name="customDomain" />

        <button type="submit">Shorten</button>
      </form>
      <div id="shortenedResult"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/login";
        } else {
          document.getElementById("loading").style.display = "none";
          document.getElementById("content").style.display = "block";
        }
      });

      document
        .getElementById("shortenForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const longURL = document.getElementById("longURL").value;
          const customDomain = document.getElementById("customDomain").value;
          const button = document.querySelector('button[type="submit"]');
          const originalText = button.textContent;

          button.textContent = "Shortening...";
          button.disabled = true;

          const token = localStorage.getItem("token");

          try {
            const response = await fetch("/api/shorten", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ longURL, customDomain }),
            });

            const result = await response.json();
            const resultDiv = document.getElementById("shortenedResult");

            if (response.ok) {
              resultDiv.innerHTML = `
          <div style="color: #28a745; background: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3); border-radius: 10px; padding: 15px; margin-top: 20px;">
            <p><strong>✅ Success!</strong></p>
            <p>Shortened URL: <a href="${result.shortURL}" target="_blank" style="color: #007bff; font-weight: bold;">${result.shortURL}</a></p>
            <button onclick="copyToClipboard('${result.shortURL}')" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Copy URL</button>
          </div>
        `;
            } else {
              resultDiv.innerHTML = `
          <div style="color: #e74c3c; background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.3); border-radius: 10px; padding: 15px; margin-top: 20px;">
            <p><strong>❌ Error:</strong> ${result.error || result.message}</p>
          </div>
        `;
            }
          } catch (error) {
            console.error("Error shortening URL:", error);
            document.getElementById("shortenedResult").innerHTML = `
        <div style="color: #e74c3c; background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.3); border-radius: 10px; padding: 15px; margin-top: 20px;">
          <p><strong>❌ Error:</strong> An unexpected error occurred! Please try again</p>
        </div>
      `;
          } finally {
            button.textContent = originalText;
            button.disabled = false;
          }
        });

      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert("URL copied to clipboard!");
          })
          .catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);
            alert("URL copied to clipboard!");
          });
      }
    </script>
  </body>
</html>
