<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login to Scissors</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>

  <body>
    <h1>Log In</h1>
    <p>Scissors, Your ultimate URL shortening platform.</p>

    <% if (typeof success !== 'undefined' && success) { %>
    <div class="success-message"><%= success %></div>
    <% } %>

    <% if (typeof error !== 'undefined' && error) { %>
    <div id="error-message"><%= error %></div>
    <% } %>

    <form id="loginForm">
      <label for="username">Username:</label>
      <input
        type="text"
        id="username"
        name="username"
        required
        placeholder="Enter your username"
      />

      <label for="password">Password:</label>
      <div class="password-container">
        <input
          type="password"
          id="password"
          name="password"
          required
          placeholder="Enter your password"
        />
        <span class="password-toggle" onclick="togglePassword('password')"
          >ðŸ”’</span
        >
      </div>

      <button type="submit">Login</button>
    </form>
    <p>Don't have an account? <a href="/signup">Sign up here</a></p>

    <script>
      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const toggle = input.nextElementSibling;

        if (input.type === "password") {
          input.type = "text";
          toggle.textContent = "ðŸ”“";
        } else {
          input.type = "password";
          toggle.textContent = "ðŸ”’";
        }
      }

      document
        .getElementById("loginForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;
          const button = document.querySelector('button[type="submit"]');
          const originalText = button.textContent;

          const existingError = document.getElementById("error-message");
          if (existingError) existingError.remove();

          button.textContent = "Logging in...";
          button.disabled = true;

          try {
            const response = await fetch("/auth/login", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify({ username, password }),
            });

            const data = await response.json();

            if (response.ok) {
              localStorage.setItem("token", data.token);
              console.log("Token stored:", data.token);
              window.location.href = "/shorten-url";
            } else {
              let errorMessage = data.message || "Login failed";
              if (errorMessage.includes("username")) {
                errorMessage =
                  "Username not found! Please check your username or sign up";
              } else if (errorMessage.includes("password")) {
                errorMessage = "Your password is incorrect! Please try again";
              }

              const errorDiv = document.createElement("div");
              errorDiv.id = "error-message";
              errorDiv.textContent = errorMessage;

              const form = document.getElementById("loginForm");
              form.parentNode.insertBefore(errorDiv, form);

              setTimeout(() => {
                if (document.getElementById("error-message")) {
                  document.getElementById("error-message").remove();
                }
              }, 6000);
            }
          } catch (error) {
            console.error("Error logging in:", error);

            // Display error message
            const errorDiv = document.createElement("div");
            errorDiv.id = "error-message";
            errorDiv.textContent = "An error occurred! Please try again";

            const form = document.getElementById("loginForm");
            form.parentNode.insertBefore(errorDiv, form);

            setTimeout(() => {
              if (document.getElementById("error-message")) {
                document.getElementById("error-message").remove();
              }
            }, 5000);
          } finally {
            button.textContent = originalText;
            button.disabled = false;
          }
        });
    </script>
  </body>
</html>
