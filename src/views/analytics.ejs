<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>URL Analytics</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <%- include('partials/navbar') %>

    <h1>URL Analytics</h1>

    <div id="analytics-form">
      <label for="shortCodeInput">Short Code:</label>
      <input
        type="text"
        id="shortCodeInput"
        placeholder="Enter Short Code (e.g., mW1FJik)"
      />
      <button onclick="fetchAnalytics()">Get Analytics</button>
    </div>

    <div id="analytics-data"></div>

    <script>
      async function fetchAnalytics() {
        const shortCode = document
          .getElementById("shortCodeInput")
          .value.trim();
        if (!shortCode) {
          alert("Please enter a short code");
          return;
        }

        const button = document.querySelector("#analytics-form button");
        const originalText = button.textContent;
        button.textContent = "Loading...";
        button.disabled = true;

        // Extract just the short code if user enters full URL
        const shortCodeOnly = shortCode.split("/").pop();

        try {
          const response = await fetch(`/api/analytics/${shortCodeOnly}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          const analyticsData = await response.json();
          const analyticsContainer = document.getElementById("analytics-data");

          if (response.ok) {
            analyticsContainer.innerHTML = `
        <div class="analytics-item">
          <p><strong>Short URL:</strong> <a href="${analyticsData.shortURL}" target="_blank">${analyticsData.shortURL}</a></p>
          <p><strong>Long URL:</strong> <a href="${analyticsData.longURL}" target="_blank">${analyticsData.longURL}</a></p>
          <p><strong>Total Clicks:</strong> <span style="color: #28a745; font-weight: bold; font-size: 1.2em;">${analyticsData.clicks}</span></p>
          <p><strong>Created At:</strong> ${new Date(analyticsData.createdAt).toLocaleString()}</p>
        </div>
      `;
          } else {
            analyticsContainer.innerHTML = `<p style="color: red;">Error: ${analyticsData.message}</p>`;
          }
        } catch (error) {
          console.error("Error loading analytics data:", error);
          document.getElementById("analytics-data").innerHTML =
            "<p style='color: red;'>An error occurred while fetching analytics data.</p>";
        } finally {
          button.textContent = originalText;
          button.disabled = false;
        }
      }
    </script>
  </body>
</html>
